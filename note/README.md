# netstack

这是用于学习的笔记，内容包含很多来自互联网其他大佬的文章，代码主要来自谷歌的netstack项目，中文注释来自蓝桥课堂和自己的一些理解，可能有理解不到位或者错误的地方，欢迎指出。

首先我们要知道我们要干什么，我们要简单地手撕一个网络协议栈，什么是一个网络协议栈呢？

简单来说，就是操作系统内核用来处理截止传输层网络报文的逻辑，从链路到网络到传输层将来自网卡的比特流解析成用户进程可以理解的数据。

那么，有了这个认知，你可能会有种不太好的预感，是的，这是个巨大的工程。所幸谷歌为我们提供了一个极简版本的网络栈，在我跌跌撞撞地复现结束后，一个可以运行echo server的工程总共一万行出头，算是一个中等大小的项目了。

## 真实的内核如何接收网络包

1. 当网卡收到数据以后，以DMA的方式把网卡收到的帧写到内存里，再向CPU发起一个中断，以通知CPU有数据到达。
2. 当CPU收到中断请求后，会去调用网络设备驱动注册的中断处理函数。网卡的中断处理函数并不做过多工作，发出软中断请求，然后尽快释放CPU资源。
3. ksoftirqd内核线程检测到有软中断请求到达，调用poll开始轮询收包，受到后交给各级协议栈处理。对于tcp包来说，会被放到用户socker的接受队列中。


